<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
						"http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace = "dmy.tipboard.dao.DmyTipBoardMapper">
	<!-- 게시판 조회수증가 -->
	<update id="viewcntboard" parameterType="DmyTipBoardVO">
		UPDATE DMY_TIPBOARD A
		SET     DTB_VIEWCNT =  DTB_VIEWCNT + 1 
		      , DTB_UPDATEDATE = SYSDATE
		WHERE   DTB_NO = #{dtb_no}
	</update>
	
	<!-- =======게시판 글 좋아요구현========= -->
	
	<!-- 1. 좋아요 클릭여부 조회 -->
	<select id="goodYNboard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
		SELECT 
	            DGD_GOODYN 
		FROM    DMY_GOOD 
		WHERE   DTB_NO = #{dtb_no,jdbcType=VARCHAR}
		AND     DMB_NO = #{session_no,jdbcType=VARCHAR}
	</select>
	
	<!-- 2-1.좋아요 클릭여부  조회 후 0 건이면 insert 하기-->
	<insert id="insertgoodcnt" parameterType="DmyTipBoardVO">
		INSERT INTO DMY_GOOD(
				DGD_NO                                 -- 좋아요번호(시퀀스)
			   ,DMB_NO                                 -- 회원번호
			   ,DTB_NO                                 -- 게시판번호
			   ,DGD_GOODYN                             -- 좋아요여부
			   ,DGD_UPDATEDATE                         -- 수정일
		)VALUES(
		       GOOD_SEQ.NEXTVAL                        -- 좋아요번호(시퀀스)
			  ,#{session_no,jdbcType=VARCHAR}          -- 회원번호
			  ,#{DTB_no,jdbcType=VARCHAR}              -- 게시판번호
			  ,'Y'                                     -- 좋아요여부
			  ,SYSDATE                                 -- 수정일
		)
	</insert>

	  
	<!-- 2-3.좋아요 클릭여부 조회  값이 'Y'일 경우 'N'으로 변경하기 -->
	<update id="updategoodN" parameterType="DmyTipBoardVO">
		UPDATE DMY_GOOD
		SET    DGD_GOODYN = 'N'
		      ,DGD_UPDATEDATE = SYSDATE
		WHERE  DTB_NO = #{dtb_no,jdbcType=VARCHAR}
		AND    DMB_NO = #{session_no,jdbcType=VARCHAR}
		AND    DGD_GOODYN = 'Y'
	</update>
	
	<!-- 내가등록한글 보기 -->
	<select id="myliDTBoard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
			SELECT LIST.*
		FROM ( SELECT L.*, ROWNUM AS DTB_ROWNUM
		FROM (  SELECT
					       DTB_NO                                                                      AS DTB_NO            -- 글번호
					      ,DTB_CATEGORY                                                                AS DTB_CATEGORY      -- 카테고리
					      ,DTB_SUBJECT                                                                 AS DTB_SUBJECT       -- 제목
					      ,DTB_VIEWCNT                                                                 AS DTB_VIEWCNT       -- 조회수
					      ,DTB_GOODCNT                                                                 AS DTB_GOODCNT       -- 좋아요
					      ,DTB_PW                                                                      AS DTB_PW            -- 비밀번호
					      ,DTB_CONTENT                                                                 AS DTB_CONTENT       -- 내용
					      ,DTB_FILE                                                                    AS DTB_FILE          -- 파일
					      ,DTB_SHAREYN                                                                 AS DTB_SHAREYN       -- 공유여부
					      ,DTB_DELETEYN                                                                AS DTB_DELETEYN      -- 삭제여부
					      ,TO_CHAR( DTB_INSERTDATE,'YYYY-MM-DD')                                        AS DTB_INSERTDATE    -- 등록일
					      ,TO_CHAR( DTB_UPDATEDATE,'YYYY-MM-DD')                                        AS DTB_UPDATEDATE    -- 수정일
					      ,DMB_NO                                                                      AS DMB_NO            -- 회원번호
					      ,(SELECT B.DMB_ID AS DMB_ID FROM DmyMATCH_MEMBER B WHERE B.DMB_NO =  DMB_NO)  AS DMB_ID            -- 아이디
					      ,CEIL(ROW_NUMBER() OVER(ORDER BY  DTB_NO DESC) / C.SPG_PAGESIZE)              AS SPG_CURPAGE
					      ,COUNT( DTB_NO) OVER()                                                        AS SPG_TOTALSIZE
					      ,C.SPG_PAGESIZE                                                                AS SPG_PAGESIZE
					      ,C.SPG_GROUPSIZE                                                               AS SPG_GROUPSIZE
		FROM       		   DMY_TIPBOARD , (SELECT * FROM DmyMATCH_PAGING WHERE SPG_TABLENO='04') C 
        WHERE               DMB_NO = #{DMB_no}
        AND                 DTB_DELETEYN = 'Y'
          	<if test="DTB_category!=null and DTB_category!='' and DTB_category!='null' and DTB_category!='전체'">
					<![CDATA[AND		 DTB_CATEGORY = #{DTB_category,jdbcType=VARCHAR}]]> 
				</if>
				<if test="searchFilter=='제목'">
					<![CDATA[AND  DTB_SUBJECT LIKE '%' || #{keyword,jdbcType=VARCHAR} || '%']]>
				</if>
				<if test="searchFilter=='내용'">
					<![CDATA[AND  DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
				<if test="searchFilter=='제목+내용'">
				<![CDATA[AND  DTB_SUBJECT LIKE '%'||#{keyword}||'%']]>
				<![CDATA[OR  DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
		ORDER BY		    DTB_NO DESC )  L ) LIST	 
		WHERE 			   SPG_CURPAGE = #{spg_curPage, jdbcType=VARCHAR}  
	</select>
	
	<!-- 팁공유게시판목록 전체조회 -->
	<select id="listallboard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
		SELECT LIST.*
		FROM ( SELECT L.*, ROWNUM AS DTB_ROWNUM
		FROM (  SELECT
					       DTB_NO                                                                      AS DTB_NO            -- 글번호
					      ,DTB_CATEGORY                                                                AS DTB_CATEGORY      -- 카테고리
					      ,DTB_SUBJECT                                                                 AS DTB_SUBJECT       -- 제목
					      ,DTB_VIEWCNT                                                                 AS DTB_VIEWCNT       -- 조회수
					      ,DTB_GOODCNT                                                                 AS DTB_GOODCNT       -- 좋아요
					      ,DTB_PW                                                                      AS DTB_PW            -- 비밀번호
					      ,DTB_CONTENT                                                                 AS DTB_CONTENT       -- 내용
					      ,DTB_FILE                                                                    AS DTB_FILE          -- 파일
					      ,DTB_SHAREYN                                                                 AS DTB_SHAREYN       -- 공유여부
					      ,DTB_DELETEYN                                                                AS DTB_DELETEYN      -- 삭제여부
					      ,TO_CHAR( DTB_INSERTDATE,'YYYY-MM-DD')                                        AS DTB_INSERTDATE    -- 등록일
					      ,TO_CHAR( DTB_UPDATEDATE,'YYYY-MM-DD')                                        AS DTB_UPDATEDATE    -- 수정일
					      ,DMB_NO                                                                      AS DMB_NO            -- 회원번호
					      ,(SELECT B.DMB_ID AS DMB_ID FROM DmyMATCH_MEMBER B WHERE B.DMB_NO =  DMB_NO)  AS DMB_ID            -- 아이디
					      ,CEIL(ROW_NUMBER() OVER(ORDER BY  DTB_NO DESC) / C.SPG_PAGESIZE)              AS SPG_CURPAGE
					      ,COUNT( DTB_NO) OVER()                                                        AS SPG_TOTALSIZE
					      ,C.SPG_PAGESIZE                                                                AS SPG_PAGESIZE
					      ,C.SPG_GROUPSIZE                                                               AS SPG_GROUPSIZE
		FROM       		   DMY_TIPBOARD A, (SELECT * FROM DMY_PAGING WHERE SPG_TABLENO='04') C 	
		 	 <if test="DTB_category!=null and DTB_category!='' and DTB_category!='null' and DTB_category!='전체'">
					<![CDATA[AND		 DTB_CATEGORY = #{DTB_category,jdbcType=VARCHAR}]]> 
				</if>
				<if test="searchFilter=='제목'">
					<![CDATA[AND  DTB_SUBJECT LIKE '%' || #{keyword,jdbcType=VARCHAR} || '%']]>
				</if>
					<if test="searchFilter=='내용'">
					<![CDATA[AND  DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
				<if test="searchFilter=='제목+내용'">
				<![CDATA[AND  DTB_SUBJECT LIKE '%'||#{keyword}||'%']]>
				<![CDATA[OR  DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
		ORDER BY		    DTB_NO DESC )  L ) LIST	 
		WHERE 			   SPG_CURPAGE = #{spg_curPage, jdbcType=VARCHAR}  
	</select>
	
	<!-- 팁공유게시판 목록조회 -->
	<select id="liDTBoard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
		SELECT LIST.*
		FROM ( SELECT L.*, ROWNUM AS DTB_ROWNUM
		FROM (  SELECT
					       DTB_NO                                                                      										AS DTB_NO            -- 글번호
					      ,DTB_CATEGORY                                                               									    AS DTB_CATEGORY      -- 카테고리
					      ,DTB_SUBJECT                                                                 										AS DTB_SUBJECT       -- 제목
					      ,DTB_VIEWCNT                                                                 										AS DTB_VIEWCNT       -- 조회수
					      ,DTB_PW                                                                      										AS DTB_PW            -- 비밀번호
					      ,DTB_CONTENT                                                                 										AS DTB_CONTENT       -- 내용
					      ,DTB_FILE                                                                    										AS DTB_FILE          -- 파일
					      ,DTB_SHAREYN                                                                 										AS DTB_SHAREYN       -- 공유여부
					      ,DTB_DELETEYN                                                                										AS DTB_DELETEYN      -- 삭제여부
					      ,TO_CHAR( DTB_INSERTDATE,'YYYY-MM-DD')                                        										AS DTB_INSERTDATE    -- 등록일
					      ,TO_CHAR( DTB_UPDATEDATE,'YYYY-MM-DD')                                        										AS DTB_UPDATEDATE    -- 수정일
					      ,DMB_NO                                                                      										AS DMB_NO            -- 회원번호
					      ,(SELECT B.DMB_ID AS DMB_ID FROM DmyMATCH_MEMBER B WHERE B.DMB_NO =  DMB_NO)  										AS DMB_ID            -- 아이디
					      ,CEIL(ROW_NUMBER() OVER(ORDER BY  DTB_NO DESC) / C.SPG_PAGESIZE)              										AS SPG_CURPAGE
					      ,COUNT( DTB_NO) OVER()                                                        										AS SPG_TOTALSIZE
					      ,C.SPG_PAGESIZE                                                                										AS SPG_PAGESIZE
					      ,C.SPG_GROUPSIZE                                                               										AS SPG_GROUPSIZE
		FROM               DMY_TIPBOARD, (SELECT * FROM DMY_PAGING WHERE SPG_TABLENO='04') C 
		WHERE              DTB_DELETEYN = 'Y'
		AND                DTB_SHAREYN = 'Y'
			    <if test="DTB_category!=null and DTB_category!='' and DTB_category!='null' and DTB_category!='전체'">
					<![CDATA[AND		 DTB_CATEGORY = #{DTB_category,jdbcType=VARCHAR}]]> 
				</if>
				<if test="searchFilter=='제목'">
					<![CDATA[AND  DTB_SUBJECT LIKE '%' || #{keyword,jdbcType=VARCHAR} || '%']]>
				</if>
					<if test="searchFilter=='내용'">
					<![CDATA[AND  DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
				<if test="searchFilter=='제목+내용'">
				<![CDATA[AND  DTB_SUBJECT LIKE '%'||#{keyword}||'%']]>
				<![CDATA[OR  DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
				
		ORDER BY         DTB_NO DESC )  L ) LIST	 
		WHERE            DPG_CURPAGE = #{dpg_curPage, jdbcType=VARCHAR}  
	</select>
	
	<!-- 팁공유게시판 상세조회 -->
	<select id ="detailboard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
        SELECT 
		           DTB_NO                                                                     						 										                                       AS DTB_NO            -- 글번호
			      ,DTB_CATEGORY                                                               						 										                                       AS DTB_CATEGORY      -- 카테고리
			      ,DTB_SUBJECT                                                                 																                                       AS DTB_SUBJECT       -- 제목
			      ,DTB_VIEWCNT                                                                						 										                                       AS DTB_VIEWCNT       -- 조회수
			      ,(SELECT COUNT(SG.SGD_GOODYN) AS SGD_GOODYN FROM DmyMATCH_GOOD SG WHERE SG.DTB_NO = #{DTB_no} AND SGD_GOODYN = 'Y')  							 		                               AS DTB_GOODCNT       -- 좋아요
			      ,NVL((SELECT SG.SGD_GOODYN AS SGD_GOODYN FROM DmyMATCH_GOOD SG WHERE   DTB_NO = SG.DTB_NO AND   DTB_NO = #{DTB_no} AND SG.DMB_NO = #{session_no} AND SG.SGD_GOODYN = 'Y'),'N')     AS MY_GOODYN         -- 나의 좋아요 여부
			      ,DTB_PW                                                                     						 									      		                               AS DTB_PW            -- 비밀번호
			      ,DTB_CONTENT                                                                						 										  		                               AS DTB_CONTENT       -- 내용
			      ,DTB_FILE                                                                   																                                       AS DTB_FILE          -- 파일
			      ,DTB_SHAREYN                                                                															   	                                       AS DTB_SHAREYN       -- 공유여부
			      ,DTB_DELETEYN                                                               						                                                                               AS DTB_DELETEYN      -- 삭제여부
			      ,TO_CHAR( DTB_INSERTDATE,'YYYY-MM-DD HH24:MI')                               						                                                                               AS DTB_INSERTDATE    -- 등록일
			      ,TO_CHAR( DTB_UPDATEDATE,'YYYY-MM-DD HH24:MI')                               						                                                                               AS DTB_UPDATEDATE    -- 수정일
			      ,DMB_NO                                                                     						                                                                               AS DMB_NO            -- 회원번호
			      ,(SELECT B.DMB_ID AS DMB_ID FROM DmyMATCH_MEMBER B WHERE B.DMB_NO =  DMB_NO) 						                                                                               AS DMB_ID            -- 아이디
		FROM        DMY_TIPBOARD A 
		WHERE	    DTB_NO = #{DTB_no}


	</select>
	
	<!-- 게시물 등록 -->
	<insert id="insertboard" parameterType="DmyTipBoardVO">
		<selectKey keyProperty="DTB_no" resultType="String" order="BEFORE">
			SELECT 'TB'|| LPAD((SELECT 
			    NVL(MAX(SUBSTR( DTB_NO,-5)),0)+1 
			    FROM DmyMATCH_TIPBOARD A),5,'0')
			FROM DUAL
		</selectKey>
		INSERT INTO DmyMATCH_TIPBOARD(
				DTB_NO,           					 -- 글번호
				DTB_CATEGORY,     					 -- 카테고리
				DTB_SUBJECT,                         -- 제목
				DTB_VIEWCNT,                         -- 조회수
				DTB_GOODCNT,                         -- 좋아요   				 
				DTB_PW,           					 -- 비밀번호
				DTB_CONTENT,       					 -- 내용
				DTB_FILE,          					 -- 파일
				DTB_SHAREYN,                         -- 공유여부
				DTB_DELETEYN,                        -- 삭제여부
				DTB_INSERTDATE,                      -- 등록일
				DTB_UPDATEDATE,        	             -- 수정일		
				DMB_NO  		                     -- 작성자
		)VALUES(
				#{DTB_no, jdbcType=VARCHAR},         -- 글번호
				#{DTB_category, jdbcType=VARCHAR},   -- 카테고리
				#{DTB_subject, jdbcType=VARCHAR},    -- 제목
				'0',                                 -- 조회수
				'0',                                 -- 좋아요
				#{DTB_pw, jdbcType=VARCHAR},         -- 비밀번호
				#{DTB_content, jdbcType=VARCHAR},    -- 내용
				#{DTB_file, jdbcType=VARCHAR},       -- 파일
				#{DTB_shareyn},                      -- 공유여부
				'Y',                                 -- 삭제여부
				SYSDATE,                             -- 등록일
				SYSDATE,                             -- 수정일
				#{DMB_no, jdbcType=VARCHAR}          -- 작성자
		)
	</insert>
	
	<!-- 게시판 수정 -->
	<update id="updateboard" parameterType="DmyTipBoardVO">
		UPDATE DmyMATCH_TIPBOARD A
    	SET     
    			 DTB_CATEGORY = #{DTB_category, jdbcType=VARCHAR},     				
				 DTB_SUBJECT = #{DTB_subject, jdbcType=VARCHAR},                       					    				
				 DTB_SHAREYN = #{DTB_shareyn, jdbcType=VARCHAR}, 
				 DTB_CONTENT = #{DTB_content, jdbcType=VARCHAR}, 
				 DTB_FILE = #{DTB_file, jdbcType=VARCHAR},          					  
                 DTB_UPDATEDATE = SYSDATE        	                                  
    	WHERE    DTB_NO = #{DTB_no, jdbcType=VARCHAR}
		AND 	 DTB_DELETEYN = 'Y'                                                  
	</update>
	
	<!-- 게시판 삭제 -->
	<update id="deleteboard" parameterType="DmyTipBoardVO">
		UPDATE DmyMATCH_TIPBOARD A
		SET 	 DTB_DELETEYN = 'N',
				 DTB_UPDATEDATE = SYSDATE
		WHERE    DTB_NO = #{DTB_no, jdbcType=VARCHAR}
		AND 	 DTB_DELETEYN = 'Y'
	</update>
</mapper>