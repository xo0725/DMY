<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
						"http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace = "dmy.tipboard.dao.DmyTipBoardMapper">
	<!-- 게시판 조회수증가 -->
	<update id="viewcntboard" parameterType="DmyTipBoardVO">
		UPDATE DMY_TIPBOARD A
		SET    A.DTB_VIEWCNT = A.DTB_VIEWCNT + 1 
		      ,A.DTB_UPDATEDATE = SYSDATE
		WHERE  A.DTB_NO = #{dtb_no}
	</update>
	
	<!-- =======게시판 글 좋아요구현========= -->
	
	<!-- 1. 좋아요 클릭여부 조회 -->
	<select id="goodYNboard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
		SELECT 
	            DGD_GOODYN 
		FROM    DMY_GOOD 
		WHERE   DTB_NO = #{dtb_no,jdbcType=VARCHAR}
		AND     DMB_NO = #{session_no,jdbcType=VARCHAR}
	</select>
	
	<!-- 2-1.좋아요 클릭여부  조회 후 0 건이면 insert 하기-->
	<insert id="insertgoodcnt" parameterType="DmyTipBoardVO">
		INSERT INTO DMY_GOOD(
				DGD_NO                                 -- 좋아요번호(시퀀스)
			   ,DMB_NO                                 -- 회원번호
			   ,DTB_NO                                 -- 게시판번호
			   ,DGD_GOODYN                             -- 좋아요여부
			   ,DGD_UPDATEDATE                         -- 수정일
		)VALUES(
		       GOOD_SEQ.NEXTVAL                        -- 좋아요번호(시퀀스)
			  ,#{session_no,jdbcType=VARCHAR}          -- 회원번호
			  ,#{dtb_no,jdbcType=VARCHAR}              -- 게시판번호
			  ,'Y'                                     -- 좋아요여부
			  ,SYSDATE                                 -- 수정일
		)
	</insert>

	  
	<!-- 2-3.좋아요 클릭여부 조회  값이 'Y'일 경우 'N'으로 변경하기 -->
	<update id="updategoodN" parameterType="DmyTipBoardVO">
		UPDATE DMY_GOOD
		SET    DGD_GOODYN = 'N'
		      ,DGD_UPDATEDATE = SYSDATE
		WHERE  DTB_NO = #{dtb_no,jdbcType=VARCHAR}
		AND    DMB_NO = #{session_no,jdbcType=VARCHAR}
		AND    DGD_GOODYN = 'Y'
	</update>
	
	<!-- 내가등록한글 보기 -->
	<select id="mylistBoard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
			SELECT LIST.*
		FROM ( SELECT L.*, ROWNUM AS DTB_ROWNUM
		FROM (  SELECT
					       A.DTB_NO                                                                      AS DTB_NO            -- 글번호
					      ,A.DTB_CATEGORY                                                                AS DTB_CATEGORY      -- 카테고리
					      ,A.DTB_SUBJECT                                                                 AS DTB_SUBJECT       -- 제목
					      ,A.DTB_VIEWCNT                                                                 AS DTB_VIEWCNT       -- 조회수
					      ,A.DTB_GOODCNT                                                                 AS DTB_GOODCNT       -- 좋아요
					      ,A.DTB_PW                                                                      AS DTB_PW            -- 비밀번호
					      ,A.DTB_CONTENT                                                                 AS DTB_CONTENT       -- 내용
					      ,A.DTB_FILE                                                                    AS DTB_FILE          -- 파일
					      ,A.DTB_SHAREYN                                                                 AS DTB_SHAREYN       -- 공유여부
					      ,A.DTB_DELETEYN                                                                AS DTB_DELETEYN      -- 삭제여부
					      ,TO_CHAR(A.DTB_INSERTDATE,'YYYY-MM-DD')                                        AS DTB_INSERTDATE    -- 등록일
					      ,TO_CHAR(A.DTB_UPDATEDATE,'YYYY-MM-DD')                                        AS DTB_UPDATEDATE    -- 수정일
					      ,A.DMB_NO                                                                      AS DMB_NO            -- 회원번호
					      ,(SELECT B.DMB_ID AS DMB_ID FROM DMY_MEMBER B WHERE B.DMB_NO = A.DMB_NO)  AS DMB_ID            -- 아이디
					      ,CEIL(ROW_NUMBER() OVER(ORDER BY A.DTB_NO DESC) / C.DPG_PAGESIZE)              AS DPG_CURPAGE
					      ,COUNT(A.DTB_NO) OVER()                                                        AS DPG_TOTALSIZE
					      ,C.DPG_PAGESIZE                                                                AS DPG_PAGESIZE
					      ,C.DPG_GROUPSIZE                                                               AS DPG_GROUPSIZE
		FROM       		   DMY_TIPBOARD A, (SELECT * FROM DMY_PAGING WHERE DPG_TABLENO='04') C 
        WHERE              A.DMB_NO = #{dmb_no}
        AND                A.DTB_DELETEYN = 'Y'
          	<if test="DTB_category!=null and DTB_category!='' and DTB_category!='null' and DTB_category!='전체'">
					<![CDATA[AND		A.DTB_CATEGORY = #{dtb_category,jdbcType=VARCHAR}]]> 
				</if>
				<if test="searchFilter=='제목'">
					<![CDATA[AND A.DTB_SUBJECT LIKE '%' || #{keyword,jdbcType=VARCHAR} || '%']]>
				</if>
				<if test="searchFilter=='내용'">
					<![CDATA[AND A.DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
				<if test="searchFilter=='제목+내용'">
				<![CDATA[AND A.DTB_SUBJECT LIKE '%'||#{keyword}||'%']]>
				<![CDATA[OR A.DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
		ORDER BY		   A.DTB_NO DESC )  L ) LIST	 
		WHERE 			   DPG_CURPAGE = #{DPG_curPage, jdbcType=VARCHAR}  
	</select>
	
	<!-- 팁공유게시판목록 전체조회 -->
	<select id="listallboard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
		SELECT LIST.*
		FROM ( SELECT L.*, ROWNUM AS DTB_ROWNUM
		FROM (  SELECT
					       A.DTB_NO                                                                      AS DTB_NO            -- 글번호
					      ,A.DTB_CATEGORY                                                                AS DTB_CATEGORY      -- 카테고리
					      ,A.DTB_SUBJECT                                                                 AS DTB_SUBJECT       -- 제목
					      ,A.DTB_VIEWCNT                                                                 AS DTB_VIEWCNT       -- 조회수
					      ,A.DTB_GOODCNT                                                                 AS DTB_GOODCNT       -- 좋아요
					      ,A.DTB_PW                                                                      AS DTB_PW            -- 비밀번호
					      ,A.DTB_CONTENT                                                                 AS DTB_CONTENT       -- 내용
					      ,A.DTB_FILE                                                                    AS DTB_FILE          -- 파일
					      ,A.DTB_SHAREYN                                                                 AS DTB_SHAREYN       -- 공유여부
					      ,A.DTB_DELETEYN                                                                AS DTB_DELETEYN      -- 삭제여부
					      ,TO_CHAR(A.DTB_INSERTDATE,'YYYY-MM-DD')                                        AS DTB_INSERTDATE    -- 등록일
					      ,TO_CHAR(A.DTB_UPDATEDATE,'YYYY-MM-DD')                                        AS DTB_UPDATEDATE    -- 수정일
					      ,A.DMB_NO                                                                      AS DMB_NO            -- 회원번호
					      ,(SELECT B.DMB_ID AS DMB_ID FROM DMY_MEMBER B WHERE B.DMB_NO = A.DMB_NO)  AS DMB_ID            -- 아이디
					      ,CEIL(ROW_NUMBER() OVER(ORDER BY A.DTB_NO DESC) / C.DPG_PAGESIZE)              AS DPG_CURPAGE
					      ,COUNT(A.DTB_NO) OVER()                                                        AS DPG_TOTALSIZE
					      ,C.DPG_PAGESIZE                                                                AS DPG_PAGESIZE
					      ,C.DPG_GROUPSIZE                                                               AS DPG_GROUPSIZE
		FROM       		   DMY_TIPBOARD A, (SELECT * FROM DMY_PAGING WHERE DPG_TABLENO='04') C 	
		 	 <if test="DTB_category!=null and DTB_category!='' and DTB_category!='null' and DTB_category!='전체'">
					<![CDATA[AND		A.DTB_CATEGORY = #{dtb_category,jdbcType=VARCHAR}]]> 
				</if>
				<if test="searchFilter=='제목'">
					<![CDATA[AND A.DTB_SUBJECT LIKE '%' || #{keyword,jdbcType=VARCHAR} || '%']]>
				</if>
					<if test="searchFilter=='내용'">
					<![CDATA[AND A.DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
				<if test="searchFilter=='제목+내용'">
				<![CDATA[AND A.DTB_SUBJECT LIKE '%'||#{keyword}||'%']]>
				<![CDATA[OR A.DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
		ORDER BY		   A.DTB_NO DESC )  L ) LIST	 
		WHERE 			   DPG_CURPAGE = #{DPG_curPage, jdbcType=VARCHAR}  
	</select>
	
	<!-- 팁공유게시판 목록조회 -->
	<select id="listBoard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
		SELECT LIST.*
		FROM ( SELECT L.*, ROWNUM AS DTB_ROWNUM
		FROM (  SELECT
					       A.DTB_NO                                                                      										AS DTB_NO            -- 글번호
					      ,A.DTB_CATEGORY                                                               									    AS DTB_CATEGORY      -- 카테고리
					      ,A.DTB_SUBJECT                                                                 										AS DTB_SUBJECT       -- 제목
					      ,A.DTB_VIEWCNT                                                                 										AS DTB_VIEWCNT       -- 조회수
					      ,A.DTB_PW                                                                      										AS DTB_PW            -- 비밀번호
					      ,A.DTB_CONTENT                                                                 										AS DTB_CONTENT       -- 내용
					      ,A.DTB_FILE                                                                    										AS DTB_FILE          -- 파일
					      ,A.DTB_SHAREYN                                                                 										AS DTB_SHAREYN       -- 공유여부
					      ,A.DTB_DELETEYN                                                                										AS DTB_DELETEYN      -- 삭제여부
					      ,TO_CHAR(A.DTB_INSERTDATE,'YYYY-MM-DD')                                        										AS DTB_INSERTDATE    -- 등록일
					      ,TO_CHAR(A.DTB_UPDATEDATE,'YYYY-MM-DD')                                        										AS DTB_UPDATEDATE    -- 수정일
					      ,A.DMB_NO                                                                      										AS DMB_NO            -- 회원번호
					      ,(SELECT B.DMB_ID AS DMB_ID FROM DMY_MEMBER B WHERE B.DMB_NO = A.DMB_NO)  										AS DMB_ID            -- 아이디
					      ,CEIL(ROW_NUMBER() OVER(ORDER BY A.DTB_NO DESC) / C.DPG_PAGESIZE)              										AS DPG_CURPAGE
					      ,COUNT(A.DTB_NO) OVER()                                                        										AS DPG_TOTALSIZE
					      ,C.DPG_PAGESIZE                                                                										AS DPG_PAGESIZE
					      ,C.DPG_GROUPSIZE                                                               										AS DPG_GROUPSIZE
		FROM               DMY_TIPBOARD A, (SELECT * FROM DMY_PAGING WHERE DPG_TABLENO='04') C 
		WHERE              A.DTB_DELETEYN = 'Y'
		AND                A.DTB_SHAREYN = 'Y'
			    <if test="DTB_category!=null and DTB_category!='' and DTB_category!='null' and DTB_category!='전체'">
					<![CDATA[AND		A.DTB_CATEGORY = #{dtb_category,jdbcType=VARCHAR}]]> 
				</if>
				<if test="searchFilter=='제목'">
					<![CDATA[AND A.DTB_SUBJECT LIKE '%' || #{keyword,jdbcType=VARCHAR} || '%']]>
				</if>
					<if test="searchFilter=='내용'">
					<![CDATA[AND A.DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
				<if test="searchFilter=='제목+내용'">
				<![CDATA[AND A.DTB_SUBJECT LIKE '%'||#{keyword}||'%']]>
				<![CDATA[OR A.DTB_CONTENT LIKE '%'||#{keyword}||'%']]>
				</if>
				
		ORDER BY        A.DTB_NO DESC )  L ) LIST	 
		WHERE           DPG_CURPAGE = #{DPG_curPage, jdbcType=VARCHAR}  
	</select>
	
	<!-- 팁공유게시판 상세조회 -->
	<select id ="detailboard" parameterType="DmyTipBoardVO" resultType="DmyTipBoardVO">
        SELECT 
		           A.DTB_NO                                                                     						 										                                       AS DTB_NO            -- 글번호
			      ,A.DTB_CATEGORY                                                               						 										                                       AS DTB_CATEGORY      -- 카테고리
			      ,A.DTB_SUBJECT                                                                 																                                       AS DTB_SUBJECT       -- 제목
			      ,A.DTB_VIEWCNT                                                                						 										                                       AS DTB_VIEWCNT       -- 조회수
			      ,(SELECT COUNT(SG.DGD_GOODYN) AS DGD_GOODYN FROM DMY_GOOD SG WHERE SG.DTB_NO = #{dtb_no} AND DGD_GOODYN = 'Y')  							 		                               AS DTB_GOODCNT       -- 좋아요
			      ,NVL((SELECT SG.DGD_GOODYN AS DGD_GOODYN FROM DMY_GOOD SG WHERE  A.DTB_NO = SG.DTB_NO AND  A.DTB_NO = #{dtb_no} AND SG.DMB_NO = #{session_no} AND SG.DGD_GOODYN = 'Y'),'N')     AS MY_GOODYN         -- 나의 좋아요 여부
			      ,A.DTB_PW                                                                     						 									      		                               AS DTB_PW            -- 비밀번호
			      ,A.DTB_CONTENT                                                                						 										  		                               AS DTB_CONTENT       -- 내용
			      ,A.DTB_FILE                                                                   																                                       AS DTB_FILE          -- 파일
			      ,A.DTB_SHAREYN                                                                															   	                                       AS DTB_SHAREYN       -- 공유여부
			      ,A.DTB_DELETEYN                                                               						                                                                               AS DTB_DELETEYN      -- 삭제여부
			      ,TO_CHAR(A.DTB_INSERTDATE,'YYYY-MM-DD HH24:MI')                               						                                                                               AS DTB_INSERTDATE    -- 등록일
			      ,TO_CHAR(A.DTB_UPDATEDATE,'YYYY-MM-DD HH24:MI')                               						                                                                               AS DTB_UPDATEDATE    -- 수정일
			      ,A.DMB_NO                                                                     						                                                                               AS DMB_NO            -- 회원번호
			      ,(SELECT B.DMB_ID AS DMB_ID FROM DMY_MEMBER B WHERE B.DMB_NO = A.DMB_NO) 						                                                                               AS DMB_ID            -- 아이디
		FROM       DMY_TIPBOARD A 
		WHERE	   A.DTB_NO = #{dtb_no}


	</select>
	
	<!-- 게시물 등록 -->
	<insert id="insertboard" parameterType="DmyTipBoardVO">
		<selectKey keyProperty="DTB_no" resultType="String" order="BEFORE">
			SELECT 'TB'|| LPAD((SELECT 
			    NVL(MAX(SUBSTR(A.DTB_NO,-5)),0)+1 
			    FROM DMY_TIPBOARD A),5,'0')
			FROM DUAL
		</selectKey>
		INSERT INTO DMY_TIPBOARD(
				DTB_NO,           					 -- 글번호
				DTB_CATEGORY,     					 -- 카테고리
				DTB_SUBJECT,                         -- 제목
				DTB_VIEWCNT,                         -- 조회수
				DTB_GOODCNT,                         -- 좋아요   				 
				DTB_PW,           					 -- 비밀번호
				DTB_CONTENT,       					 -- 내용
				DTB_FILE,          					 -- 파일
				DTB_SHAREYN,                         -- 공유여부
				DTB_DELETEYN,                        -- 삭제여부
				DTB_INSERTDATE,                      -- 등록일
				DTB_UPDATEDATE,        	             -- 수정일		
				DMB_NO  		                     -- 작성자
		)VALUES(
				#{dtb_no, jdbcType=VARCHAR},         -- 글번호
				#{dtb_category, jdbcType=VARCHAR},   -- 카테고리
				#{dtb_subject, jdbcType=VARCHAR},    -- 제목
				'0',                                 -- 조회수
				'0',                                 -- 좋아요
				#{dtb_pw, jdbcType=VARCHAR},         -- 비밀번호
				#{dtb_content, jdbcType=VARCHAR},    -- 내용
				#{dtb_file, jdbcType=VARCHAR},       -- 파일
				#{dtb_shareyn},                      -- 공유여부
				'Y',                                 -- 삭제여부
				SYSDATE,                             -- 등록일
				SYSDATE,                             -- 수정일
				#{dmb_no, jdbcType=VARCHAR}          -- 작성자
		)
	</insert>
	
	<!-- 게시판 수정 -->
	<update id="updateboard" parameterType="DmyTipBoardVO">
		UPDATE DMY_TIPBOARD A
    	SET     
    			A.DTB_CATEGORY = #{dtb_category, jdbcType=VARCHAR},     				
				A.DTB_SUBJECT = #{dtb_subject, jdbcType=VARCHAR},                       					    				
				A.DTB_SHAREYN = #{dtb_shareyn, jdbcType=VARCHAR}, 
				A.DTB_CONTENT = #{dtb_content, jdbcType=VARCHAR}, 
				A.DTB_FILE = #{dtb_file, jdbcType=VARCHAR},          					  
                A.DTB_UPDATEDATE = SYSDATE        	                                  
    	WHERE   A.DTB_NO = #{dtb_no, jdbcType=VARCHAR}
		AND 	A.DTB_DELETEYN = 'Y'                                                  
	</update>
	
	<!-- 게시판 삭제 -->
	<update id="deleteboard" parameterType="DmyTipBoardVO">
		UPDATE DMY_TIPBOARD A
		SET 	A.DTB_DELETEYN = 'N',
				A.DTB_UPDATEDATE = SYSDATE
		WHERE   A.DTB_NO = #{dtb_no, jdbcType=VARCHAR}
		AND 	A.DTB_DELETEYN = 'Y'
	</update>
</mapper>